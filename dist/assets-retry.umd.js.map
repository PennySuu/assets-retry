{"version":3,"file":"assets-retry.umd.js","sources":["../src/constants.ts","../src/util.ts","../src/collector.ts","../src/url.ts","../src/retry-async.ts","../src/retry-sync.ts","../src/retry-css.ts","../src/assets-retry.ts"],"sourcesContent":["export const retryTimesProp = 'retryTimes'\r\nexport const succeededProp = 'succeeded'\r\nexport const failedProp = 'failed'\r\nexport const maxRetryCountProp = 'maxRetryCount'\r\nexport const onRetryProp = 'onRetry'\r\nexport const onSuccessProp = 'onSuccess'\r\nexport const onFailProp = 'onFail'\r\nexport const domainProp = 'domain'\r\nexport const styleImageNoImportant = 'styleImageNoImportant'\r\nexport const innerProxyProp = '_assetsRetryProxy'\r\nexport const innerOnloadProp = '_assetsRetryOnload'\r\nexport const innerOnerrorProp = '_assetsRetryOnerror'\r\nexport const scriptTag = 'script'\r\nexport const linkTag = 'link'\r\nexport const hookedIdentifier = 'data-assets-retry-hooked'\r\nexport const ignoreIdentifier = 'data-assets-retry-ignore'\r\nexport const retryIdentifier = 'data-retry-id'\r\nexport const win = window\r\nexport const doc = window.document\r\nexport const ElementCtor = win.HTMLElement\r\nexport const ScriptElementCtor = win.HTMLScriptElement\r\nexport const StyleElementCtor = win.HTMLStyleElement\r\nexport const LinkElementCtor = win.HTMLLinkElement\r\nexport const ImageElementCtor = win.HTMLImageElement\r\n","import {\r\n    scriptTag,\r\n    linkTag,\r\n    doc,\r\n    retryIdentifier,\r\n    ScriptElementCtor,\r\n    LinkElementCtor,\r\n    ImageElementCtor,\r\n    ElementCtor\r\n} from './constants'\r\n\r\nexport const identity = function<T>(x: T): T {\r\n    return x\r\n}\r\nexport const noop = () => {\r\n    /* noop */\r\n}\r\n\r\nexport const hasOwn = Object.prototype.hasOwnProperty\r\n/**\r\n * safely calls a function\r\n *\r\n * @template T this\r\n * @template R ReturnType<func>\r\n * @param {(this: T, ...callbackArgs: any[]) => R} func\r\n * @param {T} thisArg\r\n * @param {*} args\r\n * @returns {R}\r\n */\r\nexport const safeCall = function<T, R>(\r\n    func: (this: T, ...callbackArgs: any[]) => R,\r\n    thisArg: T,\r\n    args: any\r\n): R {\r\n    // eslint-disable-next-line\r\n    if (typeof func !== 'function') {\r\n        return null as any\r\n    }\r\n    return func.call(thisArg, args)\r\n}\r\n\r\n/**\r\n * replace a substring with new one\r\n *\r\n * @param {string} current current string\r\n * @param {string} oldStr substring to replace\r\n * @param {string} newStr new string\r\n * @returns\r\n */\r\nexport const stringReplace = function(current: string, oldStr: string, newStr: string) {\r\n    const idx = current.indexOf(oldStr)\r\n    if (idx === -1) {\r\n        return current\r\n    }\r\n    return current.substring(0, idx) + newStr + current.substring(idx + oldStr.length)\r\n}\r\n\r\n/**\r\n * remove duplicates from an array of strings\r\n */\r\nexport const unique = function(array: string[]) {\r\n    const map = {} as any\r\n    array.forEach(item => {\r\n        map[item] = true\r\n    })\r\n    return Object.keys(map)\r\n}\r\n\r\n/**\r\n * convert a camelCase string to a dash-separated string.\r\n *\r\n * @param {string} str\r\n * @returns\r\n */\r\nexport const toSlug = function(str: string) {\r\n    return str.replace(/([a-z])([A-Z])/g, (_, $1, $2) => `${$1}-${$2.toLowerCase()}`)\r\n}\r\n\r\n/**\r\n * transform an array-like object to array\r\n *\r\n * @template T\r\n * @param {ArrayLike<T>} arrayLike\r\n * @returns {T[]}\r\n */\r\nexport const arrayFrom = function<T>(arrayLike: Iterable<T> | ArrayLike<T>): T[] {\r\n    return [].slice.call(arrayLike)\r\n}\r\n/**\r\n * collect all property names from current object to its ancestor\r\n *\r\n * @param {any} obj\r\n * @returns\r\n */\r\nexport const collectPropertyNames = function(obj: any) {\r\n    const getProto = Object.getPrototypeOf\r\n        ? Object.getPrototypeOf\r\n        : function(x: any) {\r\n              return x.__proto__\r\n          }\r\n    let keys = Object.keys(obj)\r\n    while (getProto(obj)) {\r\n        keys = keys.concat(Object.keys(getProto(obj)))\r\n        obj = getProto(obj)\r\n    }\r\n    return keys.filter(key => key !== 'constructor')\r\n}\r\n\r\n/**\r\n * @example\r\n * isFunctionProperty(HTMLScriptElement.prototype, 'src); // false\r\n * isFunctionProperty(HTMLScriptElement.prototype, 'getAttribute'); // true\r\n * @param {any} proto\r\n * @param {string} key\r\n * @returns\r\n */\r\nexport const isFunctionProperty = function(proto: any, key: string) {\r\n    try {\r\n        return typeof proto[key] === 'function'\r\n    } catch (e) {\r\n        // TypeError: Illegal invocation\r\n        // when evaluating properties like\r\n        // HTMLScriptElement.prototype.src\r\n        return false\r\n    }\r\n}\r\n\r\n/**\r\n * on some browsers, calling `document.write` when\r\n * `document.readyState` is `loading` will clear the whole\r\n * page, which is not what we wanted.\r\n *\r\n * @returns\r\n */\r\nexport const supportDocumentWrite = () => {\r\n    return !/Edge|MSIE|rv:/i.test(navigator.userAgent)\r\n}\r\n\r\n/**\r\n * loads a new script element by previous failed script element\r\n *\r\n * @param {HTMLScriptElement} $script previous script element\r\n * @param {string} newSrc new url to try\r\n */\r\nexport const loadNextScript = function(\r\n    $script: HTMLScriptElement,\r\n    newSrc: string,\r\n    onload: () => void = noop,\r\n    isAsync = false\r\n) {\r\n    // when dealing with failed script tags in html,\r\n    // use `document.write` to ensure the correctness\r\n    // of loading order\r\n    const isAsyncScript = isAsync || $script.defer || $script.async\r\n    // only use document.write for non-async scripts,\r\n    // which includes script tag created by document.createElement\r\n    // or with `defer` or `async` attribute\r\n    if (doc.readyState === 'loading' && supportDocumentWrite() && !isAsyncScript) {\r\n        const retryId = randomString()\r\n        const newHtml = $script.outerHTML\r\n            // delete previous retry id\r\n            .replace(/data-retry-id=\"[^\"]+\"/, '')\r\n            .replace(/src=(?:\"[^\"]+\"|.+)([ >])/, `${retryIdentifier}=${retryId} src=\"${newSrc}\"$1`)\r\n        doc.write(newHtml)\r\n        const newScript = doc.querySelector(\r\n            `script[${retryIdentifier}=\"${retryId}\"]`\r\n        ) as HTMLScriptElement\r\n        if (newScript) {\r\n            newScript.onload = onload\r\n        }\r\n        return\r\n    }\r\n    const $newScript = doc.createElement(scriptTag)\r\n    // copy script properties except src:\r\n    // type, noModule, charset, async, defer,\r\n    // crossOrigin, text, referrerPolicy, event,\r\n    // htmlFor, integrity (chrome)\r\n    Object.keys(ScriptElementCtor.prototype).forEach(function(key: string) {\r\n        if (key !== 'src' && ($script as any)[key] && typeof ($script as any)[key] !== 'object') {\r\n            try {\r\n                ;($newScript as any)[key] = ($script as any)[key]\r\n            } catch (_) {\r\n                /* noop */\r\n            }\r\n        }\r\n    })\r\n    $newScript.src = newSrc\r\n    $newScript.onload = $script.onload\r\n    $newScript.onerror = $script.onerror\r\n    $newScript.setAttribute(retryIdentifier, randomString())\r\n    // webpack nonce for csp\r\n    const originalNonce = $script.getAttribute('nonce')\r\n    if (originalNonce) {\r\n        $newScript.setAttribute('nonce', originalNonce)\r\n    }\r\n    doc.getElementsByTagName('head')[0].appendChild($newScript)\r\n}\r\n\r\n/**\r\n * get rules from styleSheet\r\n *\r\n * @param {CSSStyleSheet} styleSheet\r\n * @returns\r\n */\r\nexport const getCssRules = function(styleSheet: CSSStyleSheet) {\r\n    try {\r\n        return styleSheet.rules\r\n    } catch (_) {\r\n        try {\r\n            return styleSheet.cssRules\r\n        } catch (_) {\r\n            return null\r\n        }\r\n    }\r\n}\r\n/**\r\n * test if current browser support CSSRuleList\r\n *\r\n * @param {CSSStyleSheet} styleSheet\r\n * @returns\r\n */\r\nexport const supportRules = function(styleSheet: CSSStyleSheet) {\r\n    const rules = getCssRules(styleSheet)\r\n    return !!rules\r\n}\r\n\r\n/**\r\n * loads a new link element by previous failed link element\r\n *\r\n * @param {HTMLLinkElement} $link previous link element\r\n * @param {string} newHref new url to try\r\n */\r\nexport const loadNextLink = function($link: HTMLLinkElement, newHref: string, onload?: () => void) {\r\n    const $newLink = doc.createElement(linkTag)\r\n    // copy link properties except href:\r\n    // disabled, href, crossOrigin, rel, relList, media, hreflang,\r\n    // type, as, referrerPolicy, sizes, imageSrcset, imageSizes,\r\n    // charset, rev, target, sheet, integrity, import (chrome)\r\n    Object.keys(LinkElementCtor.prototype).forEach(function(key: string) {\r\n        if (key !== 'href' && ($link as any)[key] && typeof ($link as any)[key] !== 'object') {\r\n            try {\r\n                ;($newLink as any)[key] = ($link as any)[key]\r\n            } catch (_) {\r\n                /* noop */\r\n            }\r\n        }\r\n    })\r\n    $newLink.href = newHref\r\n    $newLink.onload = onload || $link.onload\r\n    $newLink.onerror = $link.onerror\r\n    $newLink.setAttribute(retryIdentifier, randomString())\r\n    doc.getElementsByTagName('head')[0].appendChild($newLink)\r\n}\r\n\r\nexport const hashTarget = function(element: EventTarget | null) {\r\n    if (!element) {\r\n        return 'null'\r\n    }\r\n    if (!(element instanceof ElementCtor)) {\r\n        return 'not_supported'\r\n    }\r\n    const nodeName = element.nodeName\r\n    const src = (element as any).src\r\n    const href = (element as any).href\r\n    const dataRetryId = element.getAttribute(retryIdentifier)\r\n    return [nodeName, src, href, dataRetryId].join(';')\r\n}\r\n\r\nexport const randomString = () =>\r\n    Math.random()\r\n        .toString(36)\r\n        .slice(2)\r\n\r\n/**\r\n * 获取 HTML 标签中包含的 URL 信息\r\n * @param target\r\n */\r\nexport const getTargetUrl = function(target: EventTarget | null) {\r\n    if (target instanceof ScriptElementCtor || target instanceof ImageElementCtor) {\r\n        return target.src\r\n    }\r\n    if (target instanceof LinkElementCtor) {\r\n        return target.href\r\n    }\r\n    return ''\r\n}\r\n","/** @description data collector */\r\n\r\nimport { retryTimesProp, succeededProp, failedProp } from './constants'\r\n\r\nexport interface RetryCollector {\r\n    [x: string]: RetryStatistics\r\n}\r\n\r\nexport interface RetryStatistics {\r\n    [retryTimesProp]: number\r\n    [succeededProp]: string[]\r\n    [failedProp]: string[]\r\n}\r\n\r\n// statistic collector\r\nexport const retryCollector: RetryCollector = {}\r\n","import { retryCollector, RetryStatistics } from './collector'\r\nimport { retryTimesProp, failedProp, succeededProp } from './constants'\r\n\r\nexport type Domain = string[] | { [x: string]: string }\r\nexport interface DomainMap {\r\n    [x: string]: string\r\n}\r\n\r\n/**\r\n * generate the domain map from user\r\n * @example\r\n * generateDomainMap(['a.cdn', 'b.cdn', 'c.cdn']) // {'a.cdn': 'b.cdn', 'b.cdn': 'c.cdn', 'c.cdn': 'a.cdn'}\r\n *\r\n * @param {Domain} domains\r\n * @returns {DomainMap}\r\n */\r\nexport const prepareDomainMap = function(domains: Domain): DomainMap {\r\n    // array\r\n    if (Array.isArray(domains)) {\r\n        return domains.reduce(function(domainMap, domain, idx, array) {\r\n            domainMap[domain] = array[(idx + 1) % array.length]\r\n            return domainMap\r\n        }, {} as DomainMap)\r\n    }\r\n    // object\r\n    return domains\r\n}\r\n\r\n/**\r\n * get path from src\r\n * @example\r\n * getUrlPath('https://a.cdn/js/1.js', 'a.cdn'); // '/js/1.js'\r\n * getUrlPath('https://a.cdn/namespace/js/1.js', 'a.cdn/namespace'); // '/js/1.js'\r\n * @param {string} src script src\r\n * @param {string} currentDomain domain name\r\n * @returns {string}\r\n */\r\nexport const getUrlPath = function(src: string, currentDomain: string) {\r\n    return src.substr(src.indexOf(currentDomain) + currentDomain.length, src.length)\r\n}\r\n\r\n/**\r\n * find out the domain of current loading script\r\n *\r\n * @param {string} src\r\n * @param {{ [x: string]: string }} domainMap\r\n * @returns\r\n */\r\nexport const getCurrentDomain = function(src: string, domainMap: DomainMap) {\r\n    return (\r\n        Object.keys(domainMap)\r\n            .filter(function(domain) {\r\n                return src.indexOf(domain) > -1\r\n            })\r\n            // sort by length (relevance)\r\n            .sort((prev, next) => next.length - prev.length)[0]\r\n    )\r\n}\r\n\r\n/**\r\n * extract domain from url, and get the\r\n * corresponding statistic collector\r\n * @param {string} url\r\n * @returns\r\n */\r\nexport const extractInfoFromUrl = function(\r\n    url: string,\r\n    domainMap: DomainMap\r\n): [string?, RetryStatistics?] {\r\n    const [srcPath, currentDomain] = splitUrl(url, domainMap)\r\n    if (!srcPath) {\r\n        return []\r\n    }\r\n    retryCollector[srcPath] = retryCollector[srcPath] || {\r\n        [retryTimesProp]: 0,\r\n        [failedProp]: [],\r\n        [succeededProp]: []\r\n    }\r\n    return [currentDomain, retryCollector[srcPath]]\r\n}\r\n\r\nexport const splitUrl = function(url: string, domainMap: DomainMap): [string, string] {\r\n    const currentDomain = getCurrentDomain(url, domainMap)\r\n    if (!currentDomain) {\r\n        return ['', '']\r\n    }\r\n    const srcPath = getUrlPath(url, currentDomain)\r\n    return [srcPath, currentDomain]\r\n}\r\n","import {\r\n    collectPropertyNames,\r\n    stringReplace,\r\n    isFunctionProperty,\r\n    loadNextScript,\r\n    safeCall,\r\n    hasOwn,\r\n    noop,\r\n    getTargetUrl,\r\n    loadNextLink,\r\n    unique\r\n} from './util'\r\n\r\nimport {\r\n    retryTimesProp,\r\n    maxRetryCountProp,\r\n    onRetryProp,\r\n    domainProp,\r\n    innerProxyProp,\r\n    innerOnloadProp,\r\n    innerOnerrorProp,\r\n    linkTag,\r\n    scriptTag,\r\n    hookedIdentifier,\r\n    ignoreIdentifier,\r\n    doc,\r\n    ScriptElementCtor,\r\n    LinkElementCtor\r\n} from './constants'\r\nimport { retryCollector } from './collector'\r\nimport { prepareDomainMap, extractInfoFromUrl } from './url'\r\nimport { InnerAssetsRetryOptions } from './assets-retry'\r\n\r\ntype DynamicElement = HTMLScriptElement | HTMLLinkElement\r\n\r\nexport interface HookedElement {\r\n    [innerProxyProp]: DynamicElement\r\n    [innerOnerrorProp]: (e: Partial<Event>) => void\r\n    [x: string]: any\r\n}\r\n\r\n// cache all properties of HTMLScriptElement.prototype\r\n// (including prototype properties) because it's big (length > 200)\r\n// otherwise it would be calculated every time when\r\n// a script request failed.\r\nlet scriptAndLinkProperties: string[]\r\ntry {\r\n    scriptAndLinkProperties = unique([\r\n        ...collectPropertyNames(ScriptElementCtor.prototype),\r\n        ...collectPropertyNames(LinkElementCtor.prototype)\r\n    ])\r\n} catch (_) {\r\n    /* noop */\r\n}\r\n\r\n/**\r\n * create the descriptor of hooked element object,\r\n * accessing any property on the hooked element object\r\n * will be delegated to the real HTMLElement\r\n * except onload/onerror events\r\n *\r\n * @param {any} self hookedScript\r\n * @param {object} opts\r\n * @returns\r\n */\r\nconst getHookedElementDescriptors = function(self: HookedElement, opts: InnerAssetsRetryOptions) {\r\n    const maxRetryCount = opts[maxRetryCountProp]\r\n    const domainMap = prepareDomainMap(opts[domainProp])\r\n    const onRetry = opts[onRetryProp]\r\n    return scriptAndLinkProperties.reduce(function(descriptor, key) {\r\n        const isFn = isFunctionProperty(ScriptElementCtor.prototype, key)\r\n        // for function properties,\r\n        // do not assign getters/setters\r\n        if (isFn) {\r\n            descriptor[key] = {\r\n                value: function() {\r\n                    return (self[innerProxyProp] as any)[key].apply(self[innerProxyProp], arguments)\r\n                }\r\n            }\r\n        } else {\r\n            descriptor[key] = {\r\n                set: function(newVal) {\r\n                    const realElement = self[innerProxyProp]\r\n                    if (key === 'onerror') {\r\n                        self[innerOnerrorProp] = newVal\r\n                        // hook error events,\r\n                        // forward the original onerror handler\r\n                        // to the next script element to load\r\n                        realElement.onerror = function(event: Event | string) {\r\n                            if (typeof event === 'string') return\r\n                            event.stopPropagation && event.stopPropagation()\r\n                            const callOriginalOnError = () =>\r\n                                safeCall(self[innerOnerrorProp], realElement, event)\r\n                            const url = getTargetUrl(realElement)\r\n                            const [currentDomain, currentCollector] = extractInfoFromUrl(\r\n                                url,\r\n                                domainMap\r\n                            )\r\n                            const shouldIgnore = realElement.hasAttribute(ignoreIdentifier)\r\n                            if (!currentDomain || !currentCollector || shouldIgnore) {\r\n                                return callOriginalOnError()\r\n                            }\r\n                            const newSrc = stringReplace(\r\n                                url,\r\n                                currentDomain,\r\n                                domainMap[currentDomain]\r\n                            )\r\n                            const userModifiedSrc = onRetry(newSrc, url, currentCollector)\r\n                            // if onRetry returns null, do not retry this url\r\n                            if (userModifiedSrc === null) {\r\n                                return callOriginalOnError()\r\n                            }\r\n                            // eslint-disable-next-line\r\n                            if (typeof userModifiedSrc !== 'string') {\r\n                                throw new Error('a string should be returned in `onRetry` function')\r\n                            }\r\n                            if (currentCollector[retryTimesProp] <= maxRetryCount) {\r\n                                if (realElement instanceof ScriptElementCtor) {\r\n                                    loadNextScript(realElement, userModifiedSrc, noop, true)\r\n                                } else if (realElement instanceof LinkElementCtor) {\r\n                                    loadNextLink(realElement, userModifiedSrc)\r\n                                }\r\n                            } else {\r\n                                callOriginalOnError()\r\n                            }\r\n                        }\r\n                        return\r\n                    }\r\n                    if (key === 'onload') {\r\n                        self[innerOnloadProp] = newVal\r\n                        self[innerProxyProp].onload = function(event: Event) {\r\n                            if (newVal && !newVal._called) {\r\n                                newVal._called = true\r\n                                newVal.call(self[innerProxyProp], event)\r\n                            }\r\n                        }\r\n                        return\r\n                    }\r\n                    ;(realElement as any)[key] = newVal\r\n                },\r\n                get() {\r\n                    return (self[innerProxyProp] as any)[key]\r\n                }\r\n            }\r\n        }\r\n        return descriptor\r\n    }, {} as PropertyDescriptorMap)\r\n}\r\n\r\nconst createHookedElement = function(\r\n    $element: DynamicElement,\r\n    opts: InnerAssetsRetryOptions\r\n): HookedElement {\r\n    $element.setAttribute(hookedIdentifier, 'true')\r\n    const $hookedElement: HookedElement = {\r\n        [innerProxyProp]: $element,\r\n        [innerOnerrorProp]: noop\r\n    }\r\n    const descriptors = getHookedElementDescriptors($hookedElement, opts)\r\n    Object.defineProperties($hookedElement, descriptors)\r\n    $hookedElement.onload = noop\r\n    $hookedElement.onerror = noop\r\n    return $hookedElement\r\n}\r\n\r\n/**\r\n * hook `document.createElement`\r\n * @param {InnerAssetsRetryOptions} opts\r\n */\r\nconst hookCreateElement = function(opts: InnerAssetsRetryOptions) {\r\n    const originalCreateElement = doc.createElement\r\n    ;(doc as any).createElement = function(name: string, options: any): any {\r\n        if (name === scriptTag || name === linkTag) {\r\n            return createHookedElement((originalCreateElement as any).call(doc, name), opts)\r\n        }\r\n        return originalCreateElement.call(doc, name, options)\r\n    }\r\n}\r\n\r\n/**\r\n * create a hooked function which hooks every method of target.\r\n * if a method is hooked and its arguments contains the inner script tag\r\n * it will be replaced with the value of inner script tag\r\n *\r\n * @param {any} target hook target\r\n */\r\nconst hookPrototype = function(target: any) {\r\n    const functionKeys = Object.keys(target).filter(key => isFunctionProperty(target, key))\r\n    functionKeys.forEach(key => {\r\n        const originalFunc = target[key]\r\n        target[key] = function(): any {\r\n            const args = [].slice.call(arguments).map((item: any) => {\r\n                if (!item) return item\r\n                return hasOwn.call(item, innerProxyProp) ? item[innerProxyProp] : item\r\n            })\r\n            return originalFunc.apply(this, args)\r\n        }\r\n    })\r\n}\r\n/**\r\n * init asynchronous retrying of script tags\r\n * @param {InnerAssetsRetryOptions} opts\r\n * @returns\r\n */\r\nexport default function initAsync(opts: InnerAssetsRetryOptions) {\r\n    hookCreateElement(opts)\r\n    // eslint-disable-next-line\r\n    if (typeof Node !== 'undefined') {\r\n        hookPrototype(Node.prototype)\r\n    }\r\n    // eslint-disable-next-line\r\n    if (typeof Element !== 'undefined') {\r\n        hookPrototype(Element.prototype)\r\n    }\r\n    return retryCollector\r\n}\r\n","import {\r\n    stringReplace,\r\n    loadNextScript,\r\n    loadNextLink,\r\n    hashTarget,\r\n    randomString,\r\n    arrayFrom,\r\n    getCssRules,\r\n    getTargetUrl\r\n} from './util'\r\nimport { InnerAssetsRetryOptions } from './assets-retry'\r\nimport { extractInfoFromUrl, splitUrl } from './url'\r\nimport {\r\n    retryTimesProp,\r\n    failedProp,\r\n    hookedIdentifier,\r\n    succeededProp,\r\n    doc,\r\n    retryIdentifier,\r\n    onRetryProp,\r\n    onSuccessProp,\r\n    onFailProp,\r\n    domainProp,\r\n    maxRetryCountProp,\r\n    ScriptElementCtor,\r\n    LinkElementCtor,\r\n    ImageElementCtor,\r\n    ignoreIdentifier\r\n} from './constants'\r\n\r\nconst retryCache: { [x: string]: boolean } = {}\r\n\r\n/**\r\n * init synchronous retrying of assets,\r\n * this includes the retrying of\r\n * script, link and img tags\r\n *\r\n * @export\r\n * @param {InnerAssetsRetryOptions} opts\r\n */\r\nexport default function initSync(opts: InnerAssetsRetryOptions) {\r\n    const onRetry = opts[onRetryProp]\r\n    const onSuccess = opts[onSuccessProp]\r\n    const onFail = opts[onFailProp]\r\n    const domainMap = opts[domainProp]\r\n    /**\r\n     * capture error on window\r\n     * when js / css / image failed to load\r\n     * reload the target with new domain\r\n     *\r\n     * @param {ErrorEvent} event\r\n     * @returns\r\n     */\r\n    const errorHandler = function(event: Event) {\r\n        if (!event) {\r\n            return\r\n        }\r\n        const target = event.target || event.srcElement\r\n        const originalUrl = getTargetUrl(target)\r\n        if (!originalUrl) {\r\n            // not one of script / link / image element\r\n            return\r\n        }\r\n        const [currentDomain, currentCollector] = extractInfoFromUrl(originalUrl, domainMap)\r\n        const hasIgnoreIdentifier =\r\n            target instanceof HTMLElement && target.hasAttribute(ignoreIdentifier)\r\n        if (!currentCollector || !currentDomain || hasIgnoreIdentifier) {\r\n            return\r\n        }\r\n        currentCollector[retryTimesProp]++\r\n        currentCollector[failedProp].push(originalUrl)\r\n        const isFinalRetry = currentCollector[retryTimesProp] > opts[maxRetryCountProp]\r\n        if (isFinalRetry) {\r\n            const [srcPath] = splitUrl(originalUrl, domainMap)\r\n            onFail(srcPath)\r\n        }\r\n        if (!domainMap[currentDomain] || isFinalRetry) {\r\n            // can not find a domain to switch\r\n            // or failed too many times\r\n            return\r\n        }\r\n        const newDomain = domainMap[currentDomain]\r\n        const newUrl = stringReplace(originalUrl, currentDomain, newDomain)\r\n        const userModifiedUrl = onRetry(newUrl, originalUrl, currentCollector)\r\n        // if onRetry returns null, do not retry this url\r\n        if (userModifiedUrl === null) {\r\n            return\r\n        }\r\n        // eslint-disable-next-line\r\n        if (typeof userModifiedUrl !== 'string') {\r\n            throw new Error('a string should be returned in `onRetry` function')\r\n        }\r\n        if (target instanceof ImageElementCtor && target.src) {\r\n            target.setAttribute(retryIdentifier, randomString())\r\n            target.src = userModifiedUrl\r\n            return\r\n        }\r\n        // cache retried elements\r\n        const elementId = hashTarget(target)\r\n        if (retryCache[elementId]) {\r\n            return\r\n        }\r\n        retryCache[elementId] = true\r\n        if (\r\n            target instanceof ScriptElementCtor &&\r\n            !target.getAttribute(hookedIdentifier) &&\r\n            target.src\r\n        ) {\r\n            loadNextScript(target, userModifiedUrl)\r\n            return\r\n        }\r\n        if (\r\n            target instanceof LinkElementCtor &&\r\n            !target.getAttribute(hookedIdentifier) &&\r\n            target.href\r\n        ) {\r\n            loadNextLink(target, userModifiedUrl)\r\n            return\r\n        }\r\n    }\r\n\r\n    /**\r\n     * test is link element loaded in load event\r\n     *\r\n     * @param {Event} event\r\n     */\r\n    const loadHandler = function(event: Event) {\r\n        if (!event) {\r\n            return\r\n        }\r\n        const target = event.target || event.srcElement\r\n        const originalUrl = getTargetUrl(target)\r\n        if (!originalUrl) {\r\n            // not one of script / link / image element\r\n            return\r\n        }\r\n        const [_, currentCollector] = extractInfoFromUrl(originalUrl, domainMap)\r\n        const [srcPath] = splitUrl(originalUrl, domainMap)\r\n        const callOnSuccess = () => {\r\n            if (currentCollector) {\r\n                currentCollector[succeededProp].push(originalUrl)\r\n            }\r\n            onSuccess(srcPath)\r\n        }\r\n        // script / img tags succeeded to load without retry, add to collector\r\n        if (!(target instanceof LinkElementCtor)) {\r\n            callOnSuccess()\r\n            return\r\n        }\r\n        const supportStyleSheets = doc.styleSheets\r\n        // do not support styleSheets API\r\n        if (!supportStyleSheets) {\r\n            return\r\n        }\r\n        const styleSheets = arrayFrom(doc.styleSheets) as any[]\r\n        const targetStyleSheet = styleSheets.filter(styleSheet => {\r\n            return styleSheet.href === (target as any).href\r\n        })[0]\r\n        const rules = getCssRules(targetStyleSheet)\r\n        if (rules === null) {\r\n            return\r\n        }\r\n        // if the loaded stylesheet does not have rules, treat as failed\r\n        if (rules.length === 0) {\r\n            errorHandler(event)\r\n            return\r\n        }\r\n        callOnSuccess()\r\n    }\r\n\r\n    doc.addEventListener('error', errorHandler, true)\r\n    doc.addEventListener('load', loadHandler, true)\r\n}\r\n","import { arrayFrom, stringReplace, toSlug, supportRules, getCssRules } from './util'\r\nimport { doc, domainProp, onRetryProp, StyleElementCtor } from './constants'\r\nimport { getCurrentDomain, DomainMap } from './url'\r\nimport { InnerAssetsRetryOptions } from './assets-retry'\r\n\r\ntype UrlProperty = 'backgroundImage' | 'borderImage' | 'listStyleImage'\r\n// cache for <link rel=\"stylesheet\" />\r\nconst handledStylesheets: { [x: string]: boolean } = {}\r\n// cache for <style />\r\nconst handledStyleTags: HTMLStyleElement[] = []\r\n\r\nconst processRules = function(\r\n    name: UrlProperty,\r\n    rule: CSSStyleRule,\r\n    styleSheet: CSSStyleSheet,\r\n    styleRules: CSSRuleList,\r\n    opts: InnerAssetsRetryOptions\r\n) {\r\n    const domainMap = opts[domainProp]\r\n    const onRetry = opts[onRetryProp]\r\n    const targetRule = rule.style && rule.style[name]\r\n    if (!targetRule) {\r\n        return\r\n    }\r\n    // skip data-uri\r\n    if (/^url\\([\"']?data:/.test(targetRule)) {\r\n        return\r\n    }\r\n    const [_, originalUrl] = targetRule.match(/^url\\([\"']?(.+?)[\"']?\\)/) || []\r\n    if (!originalUrl) {\r\n        return\r\n    }\r\n    const currentDomain = getCurrentDomain(originalUrl, domainMap)\r\n    if (!currentDomain) {\r\n        return\r\n    }\r\n\r\n    let domain = currentDomain;\r\n    const urlMap: Record<string, boolean> = { [domain]: true };\r\n    while (domain && domainMap[domain]) {\r\n        const newDomain = domainMap[domain];\r\n        if (urlMap[newDomain]) {\r\n            break;\r\n        }\r\n        urlMap[newDomain] = true;\r\n        domain = newDomain;\r\n    }\r\n    const urlList = Object.keys(urlMap)\r\n        .map(domain => {\r\n            const newUrl = stringReplace(originalUrl, currentDomain, domain)\r\n            const userModifiedUrl = onRetry(newUrl, originalUrl, null)\r\n            return userModifiedUrl ? `url(\"${userModifiedUrl}\")` : null;\r\n        })\r\n        .filter(Boolean)\r\n        .join(',')\r\n    const cssText = rule.selectorText + `{ ${toSlug(name)}: ${urlList} ${opts.styleImageNoImportant ? '' : '!important'}; }`\r\n    try {\r\n        styleSheet.insertRule(cssText, styleRules.length)\r\n    } catch (_) {\r\n        styleSheet.insertRule(cssText, 0)\r\n    }\r\n}\r\n\r\nconst processStyleSheets = (styleSheets: CSSStyleSheet[], opts: InnerAssetsRetryOptions) => {\r\n    const urlProperties: UrlProperty[] = ['backgroundImage', 'borderImage', 'listStyleImage']\r\n    styleSheets.forEach((styleSheet: CSSStyleSheet) => {\r\n        const rules = getCssRules(styleSheet)\r\n        if (rules === null) {\r\n            return\r\n        }\r\n        const rulesLength = rules.length;\r\n        for (let i = 0; i < rulesLength; i++) {\r\n            const rule = rules[i] as CSSStyleRule;\r\n            urlProperties.forEach(cssProperty => {\r\n                processRules(cssProperty, rule, styleSheet, rules, opts)\r\n            })\r\n        }\r\n\r\n        if (styleSheet.href) {\r\n            handledStylesheets[styleSheet.href] = true\r\n        }\r\n        if (styleSheet.ownerNode instanceof StyleElementCtor) {\r\n            handledStyleTags.push(styleSheet.ownerNode)\r\n        }\r\n    })\r\n}\r\n\r\nconst getStyleSheetsToBeHandled = (styleSheets: StyleSheetList, domainMap: DomainMap): CSSStyleSheet[] => {\r\n    const sheetsArray = arrayFrom(styleSheets) as unknown as CSSStyleSheet[];\r\n    return sheetsArray.filter(styleSheet => {\r\n        if (!supportRules(styleSheet)) {\r\n            return false\r\n        }\r\n        // <style /> tags\r\n        if (!styleSheet.href) {\r\n            const ownerNode = styleSheet.ownerNode\r\n            if (ownerNode instanceof StyleElementCtor && handledStyleTags.indexOf(ownerNode) > -1) {\r\n                return false\r\n            }\r\n            return true\r\n        }\r\n        if (handledStylesheets[styleSheet.href]) {\r\n            return false\r\n        }\r\n        const currentDomain = getCurrentDomain(styleSheet.href, domainMap)\r\n        return !!currentDomain\r\n    })\r\n}\r\n\r\nexport default function initCss(opts: InnerAssetsRetryOptions) {\r\n    // detect is support styleSheets\r\n    const supportStyleSheets = doc.styleSheets\r\n    const domainMap = opts[domainProp]\r\n    if (!supportStyleSheets) return false\r\n    setInterval(() => {\r\n        const newStyleSheets = getStyleSheetsToBeHandled(doc.styleSheets, domainMap)\r\n        if (newStyleSheets.length > 0) {\r\n            processStyleSheets(newStyleSheets, opts)\r\n        }\r\n    }, 250)\r\n}\r\n","import initAsync from './retry-async'\r\nimport initSync from './retry-sync'\r\nimport initCss from './retry-css'\r\nimport { RetryStatistics, retryCollector } from './collector'\r\nimport {\r\n    maxRetryCountProp,\r\n    onRetryProp,\r\n    onSuccessProp,\r\n    onFailProp,\r\n    domainProp,\r\n    win,\r\n    styleImageNoImportant\r\n} from './constants'\r\nimport { Domain, DomainMap, prepareDomainMap } from './url'\r\nimport { identity, noop } from './util'\r\n\r\nexport type RetryFunction = (\r\n    currentUrl: string,\r\n    originalUrl: string,\r\n    retryCollector: null | RetryStatistics\r\n) => string | null\r\nexport type SuccessFunction = (currentPath: string) => void\r\nexport type FailFunction = (currentPath: string) => void\r\n\r\nexport interface AssetsRetryOptions {\r\n    [maxRetryCountProp]: number\r\n    [onRetryProp]?: RetryFunction\r\n    [onSuccessProp]?: SuccessFunction\r\n    [onFailProp]?: FailFunction\r\n    [domainProp]: Domain\r\n    [styleImageNoImportant]?: boolean\r\n}\r\n\r\nexport interface InnerAssetsRetryOptions {\r\n    [maxRetryCountProp]: number\r\n    [onRetryProp]: RetryFunction\r\n    [onSuccessProp]: SuccessFunction\r\n    [onFailProp]: FailFunction\r\n    [domainProp]: DomainMap\r\n    [styleImageNoImportant]: boolean\r\n}\r\n\r\nexport default function init(opts: AssetsRetryOptions = {} as any) {\r\n    try {\r\n        // eslint-disable-next-line\r\n        if (typeof opts[domainProp] !== 'object') {\r\n            throw new Error('opts.domain cannot be non-object.')\r\n        }\r\n        const optionList = [maxRetryCountProp, onRetryProp, onSuccessProp, onFailProp, domainProp, styleImageNoImportant]\r\n        const invalidOptions = Object.keys(opts).filter(key => optionList.indexOf(key) === -1)\r\n        if (invalidOptions.length > 0) {\r\n            throw new Error('option name: ' + invalidOptions.join(', ') + ' is not valid.')\r\n        }\r\n        const innerOpts: InnerAssetsRetryOptions = {\r\n            [maxRetryCountProp]: opts[maxRetryCountProp] || 3,\r\n            [onRetryProp]: opts[onRetryProp] || identity,\r\n            [onSuccessProp]: opts[onSuccessProp] || noop,\r\n            [onFailProp]: opts[onFailProp] || noop,\r\n            [domainProp]: prepareDomainMap(opts[domainProp]),\r\n            [styleImageNoImportant]: opts[styleImageNoImportant] || false\r\n        }\r\n        initAsync(innerOpts)\r\n        initSync(innerOpts)\r\n        // if (__RETRY_IMAGE__) {\r\n        //     initCss(innerOpts)\r\n        // }\r\n        initCss(innerOpts)\r\n        return retryCollector\r\n    } catch (e) {\r\n        win.console && console.error('[assetsRetry] error captured', e)\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}